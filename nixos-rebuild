#!/usr/bin/env sh

__skip_git_sync=0
HOSTNAME=${HOSTNAME:=}

# cd $HOME/github/nixdots
pushd "$(dirname "$0")"

function do_rebuild() {
  old=$(readlink /nix/var/nix/profiles/system | awk -F'-' '{print $2}')

  # We need to sync git before the flake check - a nix error could prevent git sync from running
  if [[ $__skip_git_sync -eq 0 ]]; then
    ./git-sync sync "changes from $(uname -n)-gen$old on $(date '+%Y-%m-%d %H:%M:%S %Z')"
  fi

  # nix flake check --show-trace --extra-experimental-features nix-command --extra-experimental-features flakes --offline
  # if [[ $? -ne 0 ]]; then
  #   exit 1
  # fi

  sudo nixos-rebuild --flake ".#$HOSTNAME" "$1" --accept-flake-config --show-trace
  # --show-trace --option eval-cache false
  if [[ $? -ne 0 ]]; then
    exit 1
  fi

  current=$(readlink /nix/var/nix/profiles/system | awk -F'-' '{print $2}')
  echo
  echo "--- Generation $old -> $current ---"
}

while [[ $# -gt 0 ]]; do
    key="$1"
    
    case $key in
        -s | --skip-git-sync)
            __skip_git_sync=1
            shift
        ;;
        -h | --host)
            HOSTNAME=$2
            shift
        ;;
        *)
            "do_rebuild" "$@"
            popd
            exit $?
        ;;
    esac
done

# If no arguments, default to switch
if [[ $# -eq 0 ]]; then
  "do_rebuild" "switch"
  popd
  exit $?
fi